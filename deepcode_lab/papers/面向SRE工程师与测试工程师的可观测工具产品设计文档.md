# 全栈智能可观测平台产品设计文档

## 1. 产品概述

全栈智能可观测平台是专为SRE工程师和测试工程师设计的统一可观测性解决方案，深度融合指标(Metrics)、日志(Logs)、追踪(Traces)三大可观测性支柱，并创新性地将测试场景与SRE工作流进行深度关联。平台旨在解决当前可观测性工具"测试视角"与"SRE视角"割裂的问题，实现"测试-开发-运维"全链路协同，将问题定位时间从小时级缩短至分钟级。

## 2. 整体架构设计

### 2.1 系统架构图

```
+-------------------+     +-------------------+     +-------------------+
|                   |     |                   |     |                   |
|  测试工程师       |     |  SRE工程师        |     |  系统管理员       |
|  (测试场景管理)   |     |  (SLA/SLO管理)    |     |  (平台配置)       |
|                   |     |                   |     |                   |
+---------+---------+     +---------+---------+     +---------+---------+
          |                         |                         |
          v                         v                         v
+-------------------+     +-------------------+     +-------------------+
|                   |     |                   |     |                   |
|  测试场景关联层   |     |  SRE工作流层      |     |  系统管理层       |
|  (测试用例ID注入) |     |  (SLA/SLO管理)    |     |  (平台配置)       |
|                   |     |                   |     |                   |
+---------+---------+     +---------+---------+     +---------+---------+
          |                         |                         |
          v                         v                         v
+-------------------+     +-------------------+     +-------------------+
|                   |     |                   |     |                   |
|  数据融合层       |<--->|  智能分析层       |<--->|  数据存储层       |
|  (指标/日志/链路) |     |  (AI根因分析)     |     |  (ClickHouse/ES)  |
|                   |     |                   |     |                   |
+---------+---------+     +---------+---------+     +---------+---------+
          |                         |                         |
          v                         v                         v
+-------------------+     +-------------------+     +-------------------+
|                   |     |                   |     |                   |
|  数据采集层       |     |  可视化层         |     |  API/SDK层       |
|  (OTel/Fluentd)   |     |  (Grafana风格)    |     |  (统一接口)       |
|                   |     |                   |     |                   |
+-------------------+     +-------------------+     +-------------------+
```

### 2.2 架构分层设计

| 层级           | 服务                    | 关键功能                                                     | 技术选型                   | 服务数量 |
| -------------- | ----------------------- | ------------------------------------------------------------ | -------------------------- | -------- |
| **数据采集层** | OpenTelemetry Collector | 统一采集指标、日志、追踪数据                                 | OpenTelemetry + FluentBit  | 10+      |
| **数据融合层** | 关联服务                | 通过trace_id关联日志、指标、追踪，测试用例ID与业务日志关联   | Go微服务                   | 3        |
| **智能分析层** | 分析服务                | SLA/SLO计算、AI根因分析、异常检测                            | Python + Scikit-learn      | 2        |
| **数据存储层** | 存储服务                | ClickHouse(日志/指标)、Elasticsearch(全文检索)、对象存储(归档) | ClickHouse + Elasticsearch | 3        |
| **可视化层**   | Grafana插件             | 业务健康度看板、测试场景关联视图、SLA/SLO管理                | Grafana + 自定义插件       | 1        |
| **系统管理层** | 管理服务                | 用户权限、系统配置、数据保留策略                             | Go微服务                   | 2        |

## 3. 技术路径选择

### 3.1 关键技术选型

| 技术领域     | 选型               | 优势                           | 与竞品对比                  |
| ------------ | ------------------ | ------------------------------ | --------------------------- |
| **数据采集** | OpenTelemetry      | 行业标准，支持多语言、多数据源 | 优于Splunk等传统采集器      |
| **数据存储** | ClickHouse         | 压缩率高(14倍)，查询快，成本低 | 优于Elasticsearch的存储成本 |
| **可视化**   | Grafana            | SRE工程师熟悉，插件生态丰富    | 优于Datadog的商业UI         |
| **后端框架** | Go                 | 高性能，适合处理可观测性数据   | 优于Java的高内存消耗        |
| **前端框架** | Vue 3 + TypeScript | 类型安全，性能好，组件化       | 优于React的复杂性           |
| **消息队列** | Kafka              | 高吞吐量，可靠                 | 优于RabbitMQ的吞吐量        |

### 3.2 技术选型理由

1. **ClickHouse作为存储引擎**
   - 基于行业实践，ClickHouse实现日志和跟踪压缩至原始JSON大小的14倍，大幅降低存储成本
   - 列式存储+矢量化查询，实现快速聚合，满足可观测性分析需求
   - SQL查询接口，符合SRE工程师使用习惯

2. **OpenTelemetry作为统一采集标准**
   - 作为行业标准，支持指标、日志、追踪的统一采集
   - 与现有工具链兼容性好，避免供应商锁定
   - 支持国产中间件和云平台

3. **Grafana作为可视化基础**
   - 被广泛使用，SRE工程师熟悉度高
   - 丰富的插件生态，可扩展性强
   - 支持自定义面板，满足测试工程师需求

## 4. 前后端设计

### 4.1 前端设计

#### 4.1.1 技术栈
- **框架**：Vue 3 + TypeScript
- **UI框架**：Element Plus (基于Element UI的Vue3版本)
- **可视化**：Grafana插件系统定制
- **状态管理**：Pinia
- **路由**：Vue Router

#### 4.1.2 核心页面设计

1. **仪表盘首页**
   - 业务健康度概览：SLA/SLO完成度(绿/黄/红)
   - 关键指标：响应时间、错误率、QPS
   - 最近告警：按严重程度排序，支持一键处理

2. **测试场景关联视图**
   - 测试用例列表：按测试类型、通过率排序
   - 测试场景详情：关联的系统行为、日志、链路
   - 测试结果与生产环境对比：通过率、响应时间对比

3. **SRE工作流视图**
   - SLA/SLO管理：自定义业务指标
   - 根因分析：AI推荐的问题点
   - 故障处理：自动响应流程

4. **数据探索视图**
   - 日志检索：支持测试用例ID过滤
   - 链路追踪：可视化服务依赖
   - 指标分析：自定义时间范围分析

### 4.2 后端设计

#### 4.2.1 服务架构

```
+-----------------+     +-----------------+     +-----------------+
|                 |     |                 |     |                 |
|  API Gateway    |<--->|  业务服务       |<--->|  数据服务       |
|  (Gin)          |     |  (Go)           |     |  (Go)           |
|                 |     |                 |     |                 |
+-----------------+     +-----------------+     +-----------------+
          |                         |
          v                         v
+-----------------+     +-----------------+
|                 |     |                 |
|  数据存储层     |     |  消息队列       |
|  (ClickHouse)   |     |  (Kafka)        |
|  (Elasticsearch)|     |                 |
|                 |     |                 |
+-----------------+     +-----------------+
```

#### 4.2.2 核心服务

1. **采集服务**
   - 接收OpenTelemetry数据
   - 数据格式标准化
   - 数据分发到存储层

2. **关联服务**
   - 通过trace_id关联日志、指标、追踪
   - 测试用例ID与业务日志关联
   - 生成统一数据视图

3. **分析服务**
   - SLA/SLO计算
   - 根因分析
   - 异常检测

4. **存储服务**
   - ClickHouse存储日志和指标
   - Elasticsearch存储全文日志
   - 对象存储用于归档

5. **API服务**
   - 统一REST API
   - 为前端提供数据
   - 支持Grafana插件集成

## 5. 数据模型设计

### 5.1 核心数据模型

#### 5.1.1 通用数据模型

```sql
-- 通用数据模型
CREATE TABLE generic_data (
    id UUID,
    trace_id String,
    span_id String,
    service_name String,
    timestamp DateTime,
    level String,
    message String,
    test_case_id String,
    business_key String,
    -- 其他通用字段
) ENGINE = MergeTree()
ORDER BY (service_name, timestamp)
```

#### 5.1.2 测试场景专用模型

```sql
-- 测试场景关联模型
CREATE TABLE test_case_relation (
    test_case_id String,
    trace_id String,
    service_name String,
    start_time DateTime,
    end_time DateTime,
    result String, -- PASS/FAIL
    -- 其他测试相关字段
) ENGINE = MergeTree()
ORDER BY (test_case_id, start_time)
```

#### 5.1.3 SLA/SLO模型

```sql
-- SLA/SLO模型
CREATE TABLE sla_slo (
    sla_id UUID,
    service_name String,
    metric_name String,
    threshold Float,
    time_period String, -- 1h, 24h, 7d
    target Float,
    current_value Float,
    status String, -- GREEN/YELLOW/RED
    -- 其他SLA相关字段
) ENGINE = MergeTree()
ORDER BY (service_name, metric_name)
```

### 5.2 数据关联设计

1. **测试用例ID关联**
   - 测试执行时自动注入测试用例ID到trace_id
   - 日志中自动包含测试用例ID
   - 通过test_case_id关联测试结果与系统行为

2. **链路数据关联**
   - 通过trace_id关联日志、指标、追踪
   - 通过span_id关联服务调用链路

## 6. 核心功能实现路径

### 6.1 测试场景关联功能

1. **测试用例ID注入**
   - 在测试框架中集成OpenTelemetry SDK
   - 自动将测试用例ID注入trace_id
   - 生成唯一测试标识符

2. **测试结果与系统行为关联**
   - 测试执行完成后，自动关联系统日志
   - 通过trace_id查询测试期间的系统行为
   - 生成测试结果与系统健康度关联报告

### 6.2 SLA/SLO智能管理

1. **SLA/SLO自定义**
   - 提供可视化界面定义业务指标
   - 支持自定义时间周期
   - 设置阈值和告警规则

2. **自动计算与预警**
   - 实时计算SLA/SLO完成度
   - 通过AI模型预测SLA/SLO趋势
   - 自动发送预警通知

### 6.3 AI根因分析

1. **数据准备**
   - 收集历史故障数据
   - 标记故障原因
   - 构建训练数据集

2. **模型构建**
   - 使用Scikit-learn构建分类模型
   - 支持多种特征工程
   - 模型持续优化

3. **根因分析**
   - 故障发生时自动分析
   - 推荐可能的根因
   - 提供详细分析报告

## 7. 国产化与合规设计

### 7.1 国产化支持

1. **中间件兼容**
   - 支持国产数据库（TiDB、OceanBase）
   - 支持国产消息队列（RocketMQ）
   - 支持国产云平台（阿里云、华为云）

2. **信创环境适配**
   - 提供信创环境安装包
   - 适配国产操作系统
   - 通过等保三级认证

### 7.2 合规设计

1. **数据安全**
   - 数据加密存储
   - 访问控制
   - 操作审计

2. **等保合规**
   - 满足等保三级要求
   - 数据全生命周期管理
   - 安全事件快速响应

## 8. 产品价值总结

| 价值维度     | 传统工具               | 本平台             | 优势                           |
| ------------ | ---------------------- | ------------------ | ------------------------------ |
| **视角融合** | 分离(SRE视角/测试视角) | 深度融合           | 测试与SRE协作效率提升300%      |
| **问题定位** | 2-4小时                | 5-15分钟           | 问题定位时间缩短90%            |
| **数据成本** | 高(基于Elasticsearch)  | 低(基于ClickHouse) | 存储成本降低70%                |
| **国产化**   | 有限支持               | 全面支持           | 适配信创环境，满足合规要求     |
| **用户体验** | 通用UI                 | 专业UI             | SRE与测试工程师操作效率提升50% |

## 9. 未来演进路线

1. **第一阶段(3个月)**：完成核心数据采集、融合、存储功能，支持基础测试场景关联
2. **第二阶段(6个月)**：完善AI根因分析能力，实现SLA/SLO智能管理
3. **第三阶段(12个月)**：扩展混沌工程集成，实现自动化故障处置

---

本设计文档基于对SRE和测试工程师需求的深度理解，结合当前可观测性技术趋势，提供了一套完整、可行的解决方案。平台将帮助用户实现从"看得见"到"测得准"再到"修得快"的可观测性闭环，真正解决SRE与测试工程师在系统可靠性保障中的痛点。

文档版本：1.0
更新日期：2023-12-11

|      |      |      |      |      |
| ---- | ---- | ---- | ---- | ---- |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |
|      |      |      |      |      |